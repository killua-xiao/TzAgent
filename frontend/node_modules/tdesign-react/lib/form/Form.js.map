{"version":3,"file":"Form.js","sources":["../../../components/form/Form.tsx"],"sourcesContent":["import React, { useRef, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport useConfig from '../hooks/useConfig';\nimport noop from '../_util/noop';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport type { TdFormProps } from './type';\nimport useInstance from './hooks/useInstance';\nimport useForm, { HOOK_MARK } from './hooks/useForm';\nimport useWatch from './hooks/useWatch';\nimport { StyledProps } from '../common';\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\nimport FormList from './FormList';\nimport { formDefaultProps } from './defaultProps';\nimport useDefaultProps from '../hooks/useDefaultProps';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics(\n  (originalProps: FormProps, ref) => {\n    const { classPrefix, form: globalFormConfig } = useConfig();\n    const props = useDefaultProps<FormProps>(originalProps, formDefaultProps);\n    const {\n      style,\n      className,\n      labelWidth,\n      statusIcon,\n      labelAlign,\n      layout,\n      colon,\n      initialData,\n      requiredMark = globalFormConfig.requiredMark,\n      requiredMarkPosition = globalFormConfig.requiredMarkPosition,\n      scrollToFirstError,\n      showErrorMessage,\n      resetType,\n      rules,\n      errorMessage = globalFormConfig.errorMessage,\n      preventSubmitDefault,\n      disabled,\n      children,\n      id,\n      onReset,\n      onValuesChange = noop,\n    } = props;\n\n    const formClass = classNames(`${classPrefix}-form`, className, {\n      [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const [form] = useForm(props.form); // 内部与外部共享 form 实例，外部不传则内部创建\n    const formRef = useRef<HTMLFormElement>(null);\n    const formMapRef = useRef(new Map()); // 收集所有包含 name 属性 formItem 实例\n    const floatingFormDataRef = useRef({}); // 储存游离值的 formData\n    const formInstance = useInstance(props, formRef, formMapRef, floatingFormDataRef);\n\n    useImperativeHandle(ref, () => formInstance);\n    Object.assign(form, { ...formInstance });\n    form?.getInternalHooks?.(HOOK_MARK)?.setForm?.(formInstance);\n\n    // form 初始化后清空队列\n    React.useEffect(() => {\n      form?.getInternalHooks?.(HOOK_MARK)?.flashQueue?.();\n    }, [form]);\n\n    function onResetHandler(e: React.FormEvent<HTMLFormElement>) {\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        formItemRef?.current.resetField();\n      });\n      form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.([]);\n      form.store = {};\n      onReset?.({ e });\n    }\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n      const allFields = formInstance.getFieldsValue(true);\n      onValuesChange(changedValue, allFields);\n    }\n\n    function onKeyDownHandler(e: React.KeyboardEvent<HTMLFormElement>) {\n      // 禁用 input 输入框回车自动提交 form\n      if ((e.target as Element).tagName.toLowerCase() !== 'input') return;\n      if (preventSubmitDefault && e.key === 'Enter') {\n        e.preventDefault?.();\n        e.stopPropagation?.();\n      }\n    }\n\n    return (\n      <FormContext.Provider\n        value={{\n          form,\n          labelWidth,\n          statusIcon,\n          labelAlign,\n          layout,\n          colon,\n          initialData,\n          requiredMark,\n          requiredMarkPosition,\n          errorMessage,\n          showErrorMessage,\n          scrollToFirstError,\n          resetType,\n          rules,\n          disabled,\n          formMapRef,\n          floatingFormDataRef,\n          onFormItemValueChange,\n        }}\n      >\n        <form\n          ref={formRef}\n          id={id}\n          style={style}\n          className={formClass}\n          onSubmit={formInstance.submit}\n          onReset={onResetHandler}\n          onKeyDown={onKeyDownHandler}\n        >\n          {children}\n        </form>\n      </FormContext.Provider>\n    );\n  },\n  { useForm, useWatch, FormItem, FormList },\n);\n\nForm.displayName = 'Form';\n\nexport default Form;\n"],"names":["Form","forwardRefWithStatics","originalProps","ref","_form$getInternalHook","_form$getInternalHook2","_useConfig","useConfig","classPrefix","globalFormConfig","form","props","useDefaultProps","formDefaultProps","style","className","labelWidth","statusIcon","labelAlign","layout","colon","initialData","_props$requiredMark","requiredMark","_props$requiredMarkPo","requiredMarkPosition","scrollToFirstError","showErrorMessage","resetType","rules","_props$errorMessage","errorMessage","preventSubmitDefault","disabled","children","id","onReset","_props$onValuesChange","onValuesChange","noop","formClass","classNames","concat","_defineProperty","_useForm","useForm","_useForm2","_slicedToArray","formRef","useRef","formMapRef","Map","floatingFormDataRef","formInstance","useInstance","useImperativeHandle","Object","assign","_objectSpread","getInternalHooks","call","HOOK_MARK","setForm","React","useEffect","_form$getInternalHook3","_form$getInternalHook4","flashQueue","onResetHandler","e","_form$getInternalHook5","_form$getInternalHook6","_toConsumableArray","current","values","forEach","formItemRef","resetField","notifyWatch","store","onFormItemValueChange","changedValue","allFields","getFieldsValue","onKeyDownHandler","target","tagName","toLowerCase","key","_e$preventDefault","_e$stopPropagation","preventDefault","stopPropagation","createElement","FormContext","Provider","value","onSubmit","submit","onKeyDown","useWatch","FormItem","FormList","displayName"],"mappings":"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"}