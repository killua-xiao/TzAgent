{"version":3,"file":"ImageViewer.js","sources":["../../../components/image-viewer/ImageViewer.tsx"],"sourcesContent":["import React, { useMemo, useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport { isFunction } from 'lodash-es';\nimport { ImageModal } from './ImageViewerModal';\nimport { imageViewerDefaultProps } from './defaultProps';\nimport type { TdImageViewerProps } from './type';\nimport type { ImageModalProps } from './ImageViewerModal';\nimport type { StyledProps, TNode } from '../common';\nimport useImageScale from './hooks/useImageScale';\nimport useList from './hooks/useList';\nimport useViewerScale from './hooks/useViewerScale';\nimport useControlled from '../hooks/useControlled';\nimport useDefaultProps from '../hooks/useDefaultProps';\nimport { canUseDocument } from '../_util/dom';\nimport useAttach from '../hooks/useAttach';\n\nexport interface ImageViewerProps extends TdImageViewerProps, StyledProps {}\n\nconst ImageViewer: React.FC<ImageViewerProps> = (originalProps) => {\n  const props = useDefaultProps<ImageViewerProps>(originalProps, imageViewerDefaultProps);\n  const { attach, mode, trigger, images, title, imageScale: imageScaleD, viewerScale: viewerScaleD } = props;\n\n  const imageViewerAttach = useAttach('imageViewer', attach);\n  const [visible, setVisible] = useControlled(props, 'visible', (visible, context) => {\n    !visible && props?.onClose?.(context);\n  });\n\n  const [visibled, setVisibled] = useState(false);\n  const list = useList(images);\n  const imageScale = useImageScale(imageScaleD);\n  const viewerScale = useViewerScale(viewerScaleD);\n\n  const isMini = mode === 'modeless';\n\n  const close: ImageModalProps['onClose'] = (context) => {\n    setVisible(false, context);\n    setTimeout(() => setVisibled(false), 196);\n  };\n\n  const open = () => {\n    if (!images) return;\n    setVisible(true, null);\n    setVisibled(true);\n  };\n  // todo 兼容旧api，新： open close 旧： onOpen, onClose\n  // @ts-ignore TODO 待类型完善后移除\n  const uiImage: TNode = isFunction(trigger) ? trigger({ open, close, onOpen: open, onClose: close }) : trigger;\n\n  const attachElement = useMemo(() => {\n    if (!canUseDocument || !imageViewerAttach) return null;\n\n    if (typeof imageViewerAttach === 'string') {\n      return document.querySelector(imageViewerAttach);\n    }\n    if (isFunction(imageViewerAttach)) {\n      return imageViewerAttach();\n    }\n  }, [imageViewerAttach]);\n\n  return (\n    <>\n      {uiImage}\n      {(visibled || visible) &&\n        createPortal(\n          <ImageModal\n            title={title}\n            visible={visible}\n            images={list}\n            isMini={isMini}\n            imageScale={imageScale}\n            viewerScale={viewerScale}\n            zIndex={props.zIndex}\n            defaultIndex={props.defaultIndex}\n            index={props.index}\n            onIndexChange={props.onIndexChange}\n            onDownload={props.onDownload}\n            draggable={props.draggable}\n            closeOnOverlay={props.closeOnOverlay}\n            closeBtn={props.closeBtn}\n            showOverlay={props.showOverlay}\n            closeOnEscKeydown={props.closeOnEscKeydown}\n            onClose={close}\n            onOpen={open}\n            imageReferrerpolicy={props.imageReferrerpolicy}\n          />,\n          attachElement,\n        )}\n    </>\n  );\n};\n\nImageViewer.displayName = 'ImageViewer';\n\nexport default ImageViewer;\n"],"names":["ImageViewer","originalProps","props","useDefaultProps","imageViewerDefaultProps","attach","mode","trigger","images","title","imageScaleD","imageScale","viewerScaleD","viewerScale","imageViewerAttach","useAttach","_useControlled","useControlled","visible","context","_props$onClose","onClose","call","_useControlled2","_slicedToArray","setVisible","_useState","useState","_useState2","visibled","setVisibled","list","useList","useImageScale","useViewerScale","isMini","close","setTimeout","open","uiImage","isFunction","onOpen","attachElement","useMemo","canUseDocument","document","querySelector","React","createElement","Fragment","createPortal","ImageModal","zIndex","defaultIndex","index","onIndexChange","onDownload","draggable","closeOnOverlay","closeBtn","showOverlay","closeOnEscKeydown","imageReferrerpolicy","displayName"],"mappings":"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"}